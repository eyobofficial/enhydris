{% load static %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.19.3/apexcharts.min.js"></script>
<script type="text/javascript">
  // Global configuration values
  const config = {
    blue: "#008FFB",
    gray: "#546E7A",
    api: "{% url 'timeseries-chart' station_id=object.gentity.id timeseries_group_id=object.id pk=object.default_timeseries.id %}"
  };

  // Line chart
  const optionsLine = {
    series: [{
        data: []
    }],
    noData: {
      text: "Loading..."
    },
    chart: {
      id: "chartLine",
      type: "line",
      height: 230,
      zoom: {
        type: "x",
        enabled: true,
        autoScaleYaxis: true,
      },
      toolbar: {
        autoSelected: "zoom",
        show: true,
        tools: {
          download: true,
          pan: true,
          zoom: true,
          zoomin: false,
          zoomout: false,
          reset: false
        },
      }
    },
    colors: [config.gray],
    stroke: {
      width: 2
    },
    dataLabels: {
      enabled: false
    },
    fill: {
      opacity: 1
    },
    markers: {
      size: 0
    },
    xaxis: {
      type: "datetime",
      tooltip: {
        enabled: false
      }
    },
    tooltip: {
      enabled: true,
      x: {
        show: true,
        format: "MMM dd, yyyy"
      }
    }
  };
  const chartLine = new ApexCharts(
    document.querySelector("#chart-line"),
    optionsLine
  );
  chartLine.render();

  // Area ("mini") chart
  const optionsArea = {
    series: [{
        data: []
    }],
    chart: {
      id: "chartArea",
      height: 100,
      type: "area",
      brush: {
        target: "chartLine",
        enabled: true
      },
      selection: {
        enabled: true
      }
    },
    colors: [config.blue],
    fill: {
      type: "gradient",
      gradient: {
        opacityFrom: 0.91,
        opacityTo: 0.1
      },
    },
    xaxis: {
      type: "datetime",
      tooltip: {
        enabled: false
      },
      labels: {
        show: true,
        datetimeFormatter: {
          year: "yyyy",
          month: "MMM 'yy",
          day: "dd MMM",
          hour: "HH:mm"
        },
      },
    },
    yaxis: {
      tickAmount: 2
    },
  };

  const chartArea = new ApexCharts(
    document.querySelector("#chart-area"),
    optionsArea
  );
  chartArea.render();

  const renderError = () => {
    document.querySelector("#data_holder").innerHTML =
      "<h3>No data locally available!</h3>";
  };

  // Populate charts via API call
  fetch(config.api)
    .then(response => response.json())
    .then(data => {
      if (data && data[0]) {
        const mappedData = data.map((i) => [i.timestamp * 1000, Number(i.value) || 0]);
        chartLine.updateSeries([
          {
            data: mappedData
          },
        ]);
        chartArea.updateSeries([
          {
            data: mappedData
          },
        ]);
      } else {
        renderError();
      }
    })
    .catch(function () {
      renderError();
    });
</script>
